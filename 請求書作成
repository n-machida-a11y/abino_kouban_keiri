Option Explicit

'=========================================================
' 設定エリア：転記先のセル番地などを一括管理
'=========================================================
'--- 参照元（依頼検索シート）のセル ---
Private Const SRC_KEIRI_NO As String = "A5"     '請求書番号（経理用）
Private Const SRC_DATE_SUBMISSION As String = "E7" '提出日付
Private Const SRC_STAFF_NAME As String = "C5"   '担当者
Private Const SRC_PROJECT_NO As String = "D5"   '工事番号
Private Const SRC_PROJECT_NAME As String = "E5" '工事名称
Private Const SRC_START_DATE As String = "F5"   '工期 着手
Private Const SRC_END_DATE As String = "G5"     '工期 完成
Private Const SRC_AMOUNT As String = "H5"       '請負金額
Private Const SRC_DESTINATION As String = "G7"  '宛先

'--- 転記先（請求書シート）のセル ---
Private Const DEST_KEIRI_NO As String = "AF1"       '請求書№
Private Const DEST_DATE_YEAR As String = "AB3"      '年
Private Const DEST_DATE_MONTH As String = "AE3"     '月
Private Const DEST_DATE_DAY As String = "AG3"       '日
Private Const DEST_DESTINATION As String = "C5:N5"  '宛先
Private Const DEST_HONORIFIC As String = "O5"       '敬称セル
Private Const DEST_DEPT_NAME As String = "AB15:AD15" '担当部署
Private Const DEST_STAFF_NAME As String = "AG15:AH15" '担当者名
Private Const DEST_PROJECT_NAME As String = "C18:T18" '工事名称
Private Const DEST_SUBJECT As String = "F19"        '件名
Private Const DEST_AMOUNT As String = "AA19:AE19"   '金額
Private Const DEST_PROJECT_NO As String = "AK2"     '工事番号
Private Const DEST_FILENAME_CELL As String = "AK1"  '保存ファイル名セル

'--- 工期転記先（日付分解用） ---
Private Const DEST_TERM_YEAR As String = "A18"          '18行目：西暦
Private Const DEST_TERM_START_MONTH As String = "A19"   '19行目：着手月
Private Const DEST_TERM_START_DAY As String = "B19"     '19行目：着手日
Private Const DEST_TERM_TILDE As String = "B20"         '20行目：～
Private Const DEST_TERM_END_YEAR As String = "A20"      '20行目：完成年
Private Const DEST_TERM_END_MONTH As String = "A21"     '21行目：完成月
Private Const DEST_TERM_END_DAY As String = "B21"       '21行目：完成日

'=========================================================
' 【メイン】請求書作成メニュー
'=========================================================
Sub 請求書作成メニュー()
    Dim wsMenu As Worksheet
    Dim chkBox As CheckBox
    Dim btn As Button
    Dim i As Integer
    Dim arrLabels As Variant
    Dim topPos As Double
    
    Application.ScreenUpdating = False
    
    ' 既存の選択シートがあれば削除
    On Error Resume Next
    Application.DisplayAlerts = False
    Worksheets("作成選択").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    
    Set wsMenu = Worksheets.Add
    wsMenu.Name = "作成選択"
    
    With wsMenu.Range("B2")
        .Value = "作成する請求書にチェックを入れてください"
        .Font.Bold = True
        .Font.Size = 14
    End With
    
    arrLabels = Array("請求書（標準）", _
                      "請求書（振込手数料有）", _
                      "請求書（領収証有）", _
                      "請求書（振込・領収証有）", _
                      "但陽信用金庫")
    
    topPos = 60
    For i = 0 To UBound(arrLabels)
        Set chkBox = wsMenu.CheckBoxes.Add(Left:=50, Top:=topPos, Width:=200, Height:=20)
        With chkBox
            .Caption = arrLabels(i)
            .Name = "chkOption_" & (i + 1)
            .Value = xlOff
        End With
        topPos = topPos + 30
    Next i
    
    Set btn = wsMenu.Buttons.Add(Left:=50, Top:=topPos + 20, Width:=150, Height:=40)
    With btn
        .Caption = "選択した請求書を作成"
        .Font.Bold = True
        .Font.Size = 12
        .OnAction = "'GenerateFromSelection'"
    End With
    
    ActiveWindow.DisplayGridlines = False
    wsMenu.Range("A1").Select
    Application.ScreenUpdating = True
End Sub

'=========================================================
' 【内部】選択確定後の生成処理
'=========================================================
Sub GenerateFromSelection()
    Dim wsMenu As Worksheet
    Dim i As Integer
    Dim anySelected As Boolean
    Dim isSelected(1 To 5) As Boolean
    
    On Error Resume Next
    Set wsMenu = Worksheets("作成選択")
    On Error GoTo 0
    
    If wsMenu Is Nothing Then
        Exit Sub
    End If
    
    anySelected = False
    For i = 1 To 5
        On Error Resume Next
        If wsMenu.CheckBoxes("chkOption_" & i).Value = xlOn Then
            isSelected(i) = True
            anySelected = True
        End If
        On Error GoTo 0
    Next i
    
    If anySelected = False Then
        MsgBox "作成する請求書が選択されていません。", vbExclamation
        Exit Sub
    End If
    
    ' 1. 自動採番を実行
    Call AssignAccountingInvoiceNo
    
    ' 2. メニューシートを削除
    Application.DisplayAlerts = False
    wsMenu.Delete
    Application.DisplayAlerts = True
    
    Application.ScreenUpdating = False
    
    ' 3. テンプレートからシートを生成
    If isSelected(1) = True Then
        Call CreateInvoiceFromTemplate("請求書")
    End If
    If isSelected(2) = True Then
        Call CreateInvoiceFromTemplate("請求書(振込手数料有)")
    End If
    If isSelected(3) = True Then
        Call CreateInvoiceFromTemplate("請求書(領収有)")
    End If
    If isSelected(4) = True Then
        Call CreateInvoiceFromTemplate("請求書(領収有・振込手数料有）")
    End If
    If isSelected(5) = True Then
        Call CreateInvoiceFromTemplate("但陽信用金庫")
    End If
    
    Application.ScreenUpdating = True
    MsgBox "請求書の作成が完了しました。", vbInformation
End Sub

'=========================================================
' 請求書番号（経理用）の自動採番
'=========================================================
Public Sub AssignAccountingInvoiceNo()
    Dim wsRireki As Worksheet: Set wsRireki = ThisWorkbook.Sheets("依頼履歴")
    Dim wsSearch As Worksheet: Set wsSearch = ThisWorkbook.Sheets("依頼検索")
    Dim lastRow As Long, maxNo As Double, f As Range
    Dim irNo As String: irNo = Trim(wsSearch.Range("A2").Value)

    If irNo = "" Then Exit Sub
    If wsSearch.Range("A5").Value <> "" Then Exit Sub

    lastRow = wsRireki.Cells(wsRireki.Rows.Count, "B").End(xlUp).Row
    If lastRow < 3 Then
        maxNo = 0
    Else
        maxNo = Application.WorksheetFunction.Max(wsRireki.Range("B3:B" & lastRow))
    End If
    
    wsSearch.Range("A5").Value = Int(maxNo) + 1
    
    Set f = wsRireki.Columns("A").Find(What:=irNo, LookIn:=xlValues, LookAt:=xlWhole)
    If Not f Is Nothing Then
        wsRireki.Cells(f.Row, "B").Value = wsSearch.Range("A5").Value
    End If
End Sub

'=========================================================
' テンプレートコピーと転記
'=========================================================
Private Sub CreateInvoiceFromTemplate(templateName As String)
    Dim wsSrc As Worksheet: Set wsSrc = Worksheets("依頼検索")
    Sheets(templateName).Copy After:=wsSrc
    Call TransferData(wsSrc, ActiveSheet)
    
    Dim newName As String: newName = ActiveSheet.Range(DEST_FILENAME_CELL).Value
    On Error Resume Next
    ActiveSheet.Name = newName
    If Err.Number <> 0 Then
        ActiveSheet.Name = newName & "_" & Format(Now, "hhnnss")
    End If
    On Error GoTo 0
    
    Range("A18").Select
End Sub

'=========================================================
' 共通転記処理（省略なしの完全版）
'=========================================================
Private Sub TransferData(wsSource As Worksheet, wsDest As Worksheet)
    '--- 基本項目の転記 ---
    wsDest.Range(DEST_KEIRI_NO).Value = wsSource.Range(SRC_KEIRI_NO).Value
    
    ' 日付（提出日）の分解
    Dim dSub As Variant
    dSub = wsSource.Range(SRC_DATE_SUBMISSION).Value
    If IsDate(dSub) Then
        wsDest.Range(DEST_DATE_YEAR).Value = Year(dSub)
        wsDest.Range(DEST_DATE_MONTH).Value = Month(dSub)
        wsDest.Range(DEST_DATE_DAY).Value = Day(dSub)
    End If
    
    ' 宛先
    Dim destName As String: destName = wsSource.Range(SRC_DESTINATION).Value
    wsDest.Range(DEST_DESTINATION).Value = destName
    
    ' 敬称（ポップアップ維持）
    wsDest.Range(DEST_HONORIFIC).Value = DetermineHonorific(destName)

    ' 部署マスタ連携（工事番号先頭2桁）
    Dim pNo As String: pNo = wsSource.Range(SRC_PROJECT_NO).Value
    Dim deptV: On Error Resume Next
    deptV = Application.VLookup(Left(pNo, 2), ThisWorkbook.Sheets("部署マスタ").Range("A:B"), 2, False)
    On Error GoTo 0
    wsDest.Range(DEST_DEPT_NAME).Value = IIf(IsError(deptV) Or deptV = "", "建築事業部", deptV)
    
    wsDest.Range(DEST_STAFF_NAME).Value = wsSource.Range(SRC_STAFF_NAME).Value
    wsDest.Range(DEST_PROJECT_NAME).Value = wsSource.Range(SRC_PROJECT_NAME).Value
    wsDest.Range(DEST_SUBJECT).Value = "上記工事代"
    
    If IsNumeric(wsSource.Range(SRC_AMOUNT).Value) = True Then
        wsDest.Range(DEST_AMOUNT).Value = wsSource.Range(SRC_AMOUNT).Value / 1.1
    End If
    wsDest.Range(DEST_PROJECT_NO).Value = pNo
    
    '--- 工期（日付分解転記） ---
    Dim dStart As Variant, dEnd As Variant
    dStart = wsSource.Range(SRC_START_DATE).Value
    dEnd = wsSource.Range(SRC_END_DATE).Value
    
    If IsDate(dStart) Then
        wsDest.Range(DEST_TERM_YEAR).Value = Year(dStart)
        wsDest.Range(DEST_TERM_START_MONTH).Value = Month(dStart)
        wsDest.Range(DEST_TERM_START_DAY).Value = Day(dStart)
    End If
    wsDest.Range(DEST_TERM_TILDE).Value = "～"
    If IsDate(dEnd) Then
        wsDest.Range(DEST_TERM_END_MONTH).Value = Month(dEnd)
        wsDest.Range(DEST_TERM_END_DAY).Value = Day(dEnd)
        If IsDate(dStart) Then
            If Year(dStart) <> Year(dEnd) Then
                wsDest.Range(DEST_TERM_END_YEAR).Value = Year(dEnd)
            End If
        End If
    End If
    
    '--- フォント調整 ---
    Dim destRange As Range: Set destRange = wsDest.Range(DEST_DESTINATION)
    Dim honorRange As Range: Set honorRange = wsDest.Range(DEST_HONORIFIC)
    Dim txtLen As Long: txtLen = Len(destRange.Cells(1).Value)
    
    destRange.ShrinkToFit = False
    If txtLen > 13 Then
        destRange.Font.Size = 14: honorRange.Font.Size = 14
    Else
        destRange.Font.Size = 20: honorRange.Font.Size = 20
    End If
    destRange.ShrinkToFit = True
    
    ' 保存ファイル名生成
    Dim fn As String: fn = wsSource.Range(SRC_KEIRI_NO).Value & "_請求書_" & destName & "_" & pNo
    Dim invalid, c: invalid = Array("/", "\", ":", "*", "?", "<", ">", "|")
    For Each c In invalid: fn = Replace(fn, c, " "): Next
    wsDest.Range(DEST_FILENAME_CELL).Value = fn
End Sub

Private Function DetermineHonorific(ByVal t As String) As String
    If MsgBox("宛名：「" & t & "」の敬称は『様』でよろしいですか？", vbYesNo + vbQuestion) = vbNo Then
        DetermineHonorific = "御中"
    Else
        DetermineHonorific = "様"
    End If
End Function
