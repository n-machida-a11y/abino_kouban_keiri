Option Explicit

'--- 初期設定 ---
' Trueにすると、下のテスト用ファイルパスが使われる（開発者向け）
Private Const IS_TEST_MODE As Boolean = True
' テスト時に使用する「工事番号管理表.xlsm」（コピー元のマスターファイル）の場所
Private Const m_TEST_FILE_PATH_FOR_TEST As String = "Z:\Users\n-machida\Desktop\工事番号管理表.xlsm"

'--- シート名定義 ---
Private Const m_IRAI_RIREKI_SHEET_NAME As String = "依頼履歴"
Private Const m_IRAI_SEARCH_SHEET_NAME As String = "依頼検索" ' ★ 検索キー取得・転記先シート名
' 請求書テンプレートに関する定数（m_SEIKYUUSHO_SHEET_NAME）は削除しました


'================================================================================
' 外部ファイルの「依頼履歴」をコピーし、ローカルシートを最新に更新する関数
' 成功した場合はTrue、失敗した場合はFalseを返す
' ★ 操作履歴（X列）と経理メモ（Y列）はローカルの値を保持するように修正
'================================================================================
Function UpdateKeiriRirekiSheet(Optional ByVal ShowMessage As Boolean = True) As Boolean
    Dim wbTarget As Workbook
    Dim wsSource As Worksheet ' コピー元：外部ファイル（工事番号管理表）の「依頼履歴」シート
    Dim wsDest As Worksheet   ' コピー先：このツール（経理用ファイル）内の「依頼履歴」シート
    Dim targetFilePath As String
    Dim lastRowSource As Long
    Dim copyRange As Range
    
    Dim originalDisplayAlerts As Boolean
    Dim originalEnableEvents As Boolean
    Dim originalScreenUpdating As Boolean

    UpdateKeiriRirekiSheet = False ' 最初にFalseを設定 (デフォルトは失敗)

    ' --- 処理中の画面のちらつきや不要なメッセージを抑制し、高速化 ---
    originalScreenUpdating = Application.ScreenUpdating
    originalDisplayAlerts = Application.DisplayAlerts
    originalEnableEvents = Application.EnableEvents
    
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.EnableEvents = False

    On Error GoTo ErrorHandlerUpdateKeiriRireki

    ' --- 1. 外部ファイルのパスを取得 ---
    If IS_TEST_MODE Then
        targetFilePath = m_TEST_FILE_PATH_FOR_TEST ' テストモード
    Else
        ' 通常モード：このツールの「依頼履歴」シート G1セルからパスを取得
        targetFilePath = Trim(CStr(ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME).Range("G1").Value))
    End If

    ' ファイルが存在するかチェック
    If Dir(targetFilePath) = "" Then
        MsgBox "対象のファイルが見つかりません。" & vbCrLf & targetFilePath, vbCritical, "ファイルエラー"
        GoTo FinalizeUpdateKeiriRireki
    End If

    ' --- 2. 外部ファイルを読み取り専用で開く ---
    On Error Resume Next
    Set wbTarget = Application.Workbooks.Open(fileName:=targetFilePath, ReadOnly:=True, UpdateLinks:=0)
    On Error GoTo ErrorHandlerUpdateKeiriRireki

    If wbTarget Is Nothing Then
        MsgBox "対象のExcelファイルを開けませんでした。" & vbCrLf & _
               "他のユーザーが使用中である可能性があります。", vbCritical
        GoTo FinalizeUpdateKeiriRireki
    End If

    ' --- 3. 必要なシートの存在チェック ---
    If Not SheetExists(wbTarget, m_IRAI_RIREKI_SHEET_NAME) Then
        MsgBox "外部ファイルに必要なシート「" & m_IRAI_RIREKI_SHEET_NAME & "」が見つかりません。", vbCritical, "シートエラー"
        GoTo FinalizeUpdateKeiriRireki
    End If
    Set wsSource = wbTarget.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    
    If Not SheetExists(ThisWorkbook, m_IRAI_RIREKI_SHEET_NAME) Then
        MsgBox "このファイルにコピー先のシート「" & m_IRAI_RIREKI_SHEET_NAME & "」が見つかりませんでした。", vbExclamation
        GoTo FinalizeUpdateKeiriRireki
    End If
    Set wsDest = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)

    ' --- 4. データのコピー処理を実行 ---
    wsDest.Unprotect
    ' ローカルのヘッダー行（2行目）を除いてクリア (★ A3:W までをクリア。X, Y列はクリアしない)
    wsDest.Range("A3:W" & wsDest.Rows.Count).Clear

    lastRowSource = wsSource.Cells(wsSource.Rows.Count, "A").End(xlUp).Row

    ' 外部ファイルのデータ開始行（2行目）から最終行までをコピー (★ A2:W まで。X, Y列を含めない)
    If lastRowSource < 2 Then ' データ行が2行目未満（データがない）場合はコピーしない
        Set copyRange = Nothing
    Else
        Set copyRange = wsSource.Range("A2:W" & lastRowSource)
    End If

    If Not copyRange Is Nothing Then
        ' ローカルのデータ開始行（3行目）に貼り付け
        copyRange.Copy Destination:=wsDest.Range("A3")
    End If

    
    If ShowMessage Then
        MsgBox "「" & m_IRAI_RIREKI_SHEET_NAME & "」シートが（外部ファイル）から正常に更新されました。", vbInformation, "更新完了"
    End If

    UpdateKeiriRirekiSheet = True ' 正常終了フラグを立てる

FinalizeUpdateKeiriRireki: ' 終了処理（正常終了でもエラー発生でも必ずここを通る）
    ' --- 後片付け ---
    Application.CutCopyMode = False
    If Not wsSource Is Nothing Then Set wsSource = Nothing
    If Not wsDest Is Nothing Then Set wsDest = Nothing
    If Not wbTarget Is Nothing Then wbTarget.Close SaveChanges:=False

    ' --- Excelの設定を元に戻す ---
    Application.ScreenUpdating = originalScreenUpdating
    Application.DisplayAlerts = originalDisplayAlerts
    Application.EnableEvents = originalEnableEvents
    Exit Function

ErrorHandlerUpdateKeiriRireki:
    MsgBox "「" & m_IRAI_RIREKI_SHEET_NAME & "」シート（経理用）の更新中にエラーが発生しました: " & Err.Description, vbCritical, "更新エラー"
    Resume FinalizeUpdateKeiriRireki
End Function


'================================================================================
' 依頼NOに基づいて依頼履歴を検索し、「依頼検索」シートに転記する関数
' 成功した場合はTrue、失敗した場合はFalseを返す
'================================================================================
Function SearchAndTransferRireki(Optional ByVal ShowMessage As Boolean = True) As Boolean
    Dim wsRireki As Worksheet           ' 依頼履歴シート
    Dim wsSearch As Worksheet           ' 依頼検索シート ★ 検索キー取得用・転記先
    Dim targetIraiNo As String          ' 検索対象の依頼NO
    Dim foundRange As Range             ' 検索結果のセル
    Dim dataRow As Long                 ' データが見つかった行番号
    Dim colIndex As Long                ' 列インデックス用
    
    SearchAndTransferRireki = False ' 最初にFalseを設定 (デフォルトは失敗)
    
    ' --- 処理中の画面のちらつきや不要なメッセージを抑制し、高速化 ---
    Application.ScreenUpdating = False
    Dim originalDisplayAlerts As Boolean: originalDisplayAlerts = Application.DisplayAlerts
    Dim originalEnableEvents As Boolean: originalEnableEvents = Application.EnableEvents
    Application.DisplayAlerts = False
    Application.EnableEvents = False

    On Error GoTo ErrorHandlerSearch

    ' --- 1. 依頼履歴を最新に更新（必ず最新のデータで検索できるようにする） ---
    If Not UpdateKeiriRirekiSheet(False) Then
        If ShowMessage Then MsgBox "依頼履歴の更新に失敗したため、検索を中止します。", vbCritical, "検索中止"
        GoTo FinalizeSearch
    End If
    
    ' --- 2. 必要なシートを取得 ---
    If Not SheetExists(ThisWorkbook, m_IRAI_RIREKI_SHEET_NAME) Or _
       Not SheetExists(ThisWorkbook, m_IRAI_SEARCH_SHEET_NAME) Then
        MsgBox "このファイルに「" & m_IRAI_RIREKI_SHEET_NAME & "」または「" & m_IRAI_SEARCH_SHEET_NAME & "」が見つかりません。", vbCritical
        GoTo FinalizeSearch
    End If
    
    Set wsRireki = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    Set wsSearch = ThisWorkbook.Sheets(m_IRAI_SEARCH_SHEET_NAME)

    ' --- 3. 検索対象の依頼NOを取得 ---
    targetIraiNo = Trim(CStr(wsSearch.Range("A2").Value))
    
    If targetIraiNo = "" Then
        MsgBox "「" & m_IRAI_SEARCH_SHEET_NAME & "」シートのA2セルに依頼NOを入力してください。", vbExclamation
        GoTo FinalizeSearch
    End If

    ' --- 4. 依頼履歴シートから該当データを検索 ---
    Set foundRange = wsRireki.Columns("A").Find(What:=targetIraiNo, LookIn:=xlValues, LookAt:=xlWhole, After:=wsRireki.Cells(2, "A"))
    
    If foundRange Is Nothing Then
        MsgBox "依頼NO「" & targetIraiNo & "」に一致するデータが「" & m_IRAI_RIREKI_SHEET_NAME & "」シートに見つかりませんでした。", vbExclamation
        
        ' データが見つからなかった場合、以前の転記結果をクリア
        ' A5:H5, A7:I7, A9:G9 の範囲をクリア（G9に経理メモを追加したため）
        wsSearch.Range("A5:H5, A7:I7, A9:G9").ClearContents
        
        GoTo FinalizeSearch
    End If
    
    dataRow = foundRange.Row ' データが見つかった行番号

    ' ==========================================================================
    ' 【転記処理】依頼履歴のデータをご要望の3ブロックに分けて転記
    ' ==========================================================================
    
    ' --- [ブロック 1] 5行目 (A5～H5) 転記 ---
    ' 転記元: 依頼履歴の 2列目(B)～9列目(I) = 8列
    ' 転記先: 依頼検索の 1列目(A5)～8列目(H5)
    ' 開始列: 依頼履歴の 2列目
    For colIndex = 1 To 8
        ' 転記元列インデックス: 2 + (colIndex - 1)
        wsSearch.Cells(5, colIndex).Value = wsRireki.Cells(dataRow, 2 + colIndex - 1).Value
    Next colIndex
    
    ' --- [ブロック 2] 7行目 (A7～I7) 転記 ---
    ' 転記元: 依頼履歴の 10列目(J)～18列目(R) = 9列
    ' 転記先: 依頼検索の 1列目(A7)～9列目(I7)
    ' 開始列: 依頼履歴の 10列目
    For colIndex = 1 To 9
        ' 転記元列インデックス: 10 + (colIndex - 1)
        wsSearch.Cells(7, colIndex).Value = wsRireki.Cells(dataRow, 10 + colIndex - 1).Value
    Next colIndex
    
    ' --- [ブロック 3] 9行目 (A9～G9) 転記 ---
    ' 転記元: 依頼履歴の 19列目(S)～25列目(Y) = 7列
    ' 転記先: 依頼検索の 1列目(A9)～7列目(G9)
    ' 開始列: 依頼履歴の 19列目 (S列)
    ' ※操作履歴 (X列=24), 経理メモ (Y列=25) に対応するため、転記を7列に拡張 (A9:G9)
    For colIndex = 1 To 7
        ' 転記元列インデックス: 19 + (colIndex - 1)
        wsSearch.Cells(9, colIndex).Value = wsRireki.Cells(dataRow, 19 + colIndex - 1).Value
    Next colIndex
    ' ==========================================================================
    
    If ShowMessage Then
        MsgBox "依頼NO「" & targetIraiNo & "」の依頼情報が「" & m_IRAI_SEARCH_SHEET_NAME & "」シートに転記されました。", vbInformation, "検索完了"
    End If

    SearchAndTransferRireki = True ' 正常終了フラグを立てる

FinalizeSearch: ' 終了処理
    Application.DisplayAlerts = originalDisplayAlerts
    Application.EnableEvents = originalEnableEvents
    Application.ScreenUpdating = True
    Exit Function

ErrorHandlerSearch: ' エラー発生時の処理
    MsgBox "依頼情報の検索・転記中に予期せぬエラーが発生しました: " & Err.Description, vbCritical
    Resume FinalizeSearch
End Function

'================================================================================
' 【プライベート関数】新しい依頼番号（依頼NO）を発番する
' 依頼履歴のA列の最大値に1を足した値を文字列で返す
'================================================================================
Private Function GetNewIraiNo(wsRireki As Worksheet) As String
    Dim lastRow As Long
    Dim maxVal As Double
    
    lastRow = wsRireki.Cells(wsRireki.Rows.Count, "A").End(xlUp).Row
    
    ' A3セル以降の数値の最大値を取得
    On Error Resume Next
    maxVal = Application.WorksheetFunction.Max(wsRireki.Range("A3:A" & lastRow))
    On Error GoTo 0
    
    ' 最大値に1を足して新しい依頼NOとする
    GetNewIraiNo = CStr(maxVal + 1)
End Function

'================================================================================
' 【プライベートプロシージャ】依頼検索シートのデータを依頼履歴に転記する
' isNew: True=新規追加 (データは最終行へ追加)、False=上書き (dataRowへ上書き)
'================================================================================
Private Sub SaveRirekiData(wsRireki As Worksheet, wsSearch As Worksheet, dataRow As Long, isNew As Boolean)
    Dim colIndex As Long
    Dim nextCol As Long ' 転記先（依頼履歴）の列インデックス

    wsRireki.Unprotect ' 保護を一時的に解除

    ' 1. 5行目 (A5:H5) -> 依頼履歴の2列目(B)～9列目(I)
    nextCol = 2
    For colIndex = 1 To 8
        wsRireki.Cells(dataRow, nextCol).Value = wsSearch.Cells(5, colIndex).Value
        nextCol = nextCol + 1
    Next colIndex

    ' 2. 7行目 (A7:I7) -> 依頼履歴の10列目(J)～18列目(R)
    nextCol = 10
    For colIndex = 1 To 9
        wsRireki.Cells(dataRow, nextCol).Value = wsSearch.Cells(7, colIndex).Value
        nextCol = nextCol + 1
    Next colIndex

    ' 3. 9行目 (A9～G9) -> 依頼履歴の19列目(S)～25列目(Y) (操作履歴, 経理メモ含む)
    nextCol = 19
    For colIndex = 1 To 7
        wsRireki.Cells(dataRow, nextCol).Value = wsSearch.Cells(9, colIndex).Value
        nextCol = nextCol + 1
    Next colIndex

    If isNew Then
        ' 新規発行の場合、依頼書作成日 (依頼履歴 J列=10列目) を今日の日付にする
        ' ただし、wsSearch.Cells(7, 1) が空でなければ、そちらを優先する
        If IsEmpty(wsSearch.Cells(7, 1).Value) Then
            wsRireki.Cells(dataRow, 10).Value = Date
            wsSearch.Cells(7, 1).Value = Date ' 依頼検索シートにも反映
        End If
        
        ' 新規発行の場合、操作履歴（依頼履歴 X列=24列目）を記録する
        wsRireki.Cells(dataRow, 24).Value = "新規発行: " & Format(Now, "yyyy/mm/dd hh:mm:ss")
        wsSearch.Cells(9, 6).Value = wsRireki.Cells(dataRow, 24).Value ' 依頼検索シートのF9にも反映
        
    Else ' 上書きの場合
        ' 上書き保存の場合、操作履歴（依頼履歴 X列=24列目）に追記する
        Dim currentHistory As String
        currentHistory = wsRireki.Cells(dataRow, 24).Value
        wsRireki.Cells(dataRow, 24).Value = currentHistory & vbCrLf & "更新: " & Format(Now, "yyyy/mm/dd hh:mm:ss")
        wsSearch.Cells(9, 6).Value = wsRireki.Cells(dataRow, 24).Value ' 依頼検索シートのF9にも反映
    End If

End Sub

'================================================================================
' ユーザーに「上書き保存」か「新規発行」かを選択させるマクロ
'================================================================================
Sub SaveAndPublishRireki()
    Dim wsRireki As Worksheet
    Dim wsSearch As Worksheet
    Dim targetIraiNo As String
    Dim foundRange As Range
    Dim dataRow As Long
    Dim newIraiNo As String
    Dim res As VbMsgBoxResult
    
    ' シートの存在チェック
    If Not SheetExists(ThisWorkbook, m_IRAI_RIREKI_SHEET_NAME) Or Not SheetExists(ThisWorkbook, m_IRAI_SEARCH_SHEET_NAME) Then
        MsgBox "必要なシートが見つかりません。", vbCritical
        Exit Sub
    End If

    Set wsRireki = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    Set wsSearch = ThisWorkbook.Sheets(m_IRAI_SEARCH_SHEET_NAME)
    
    targetIraiNo = Trim(CStr(wsSearch.Range("A2").Value))
    
    If targetIraiNo = "" Then
        MsgBox "依頼NO（A2セル）が空のため、処理を中止します。", vbExclamation
        Exit Sub
    End If
    
    ' 依頼履歴シートから既存の依頼NOを検索
    Set foundRange = wsRireki.Columns("A").Find(What:=targetIraiNo, LookIn:=xlValues, LookAt:=xlWhole, After:=wsRireki.Cells(2, "A"))
    
    If foundRange Is Nothing Then
        ' 検索しても見つからなかった場合（SearchAndTransferRireki実行後の手動クリアなど）
        res = MsgBox("依頼NO「" & targetIraiNo & "」は依頼履歴に見つかりません。" & vbCrLf & _
                     "新規発行として登録しますか？", vbYesNo + vbQuestion, "新規発行の確認")
        If res = vbNo Then Exit Sub
        
        ' 強制的に新規発行フローへ
        GoTo NewPublishFlow
        
    Else
        ' 既存の依頼NOが見つかった場合
        res = MsgBox("依頼NO「" & targetIraiNo & "」の処理を選択してください。" & vbCrLf & vbCrLf & _
                     "【はい】：現在の依頼NOに**上書き保存**（データを更新）" & vbCrLf & _
                     "【いいえ】：**新しい依頼NOを発番**し、新規発行（データを追加）" & vbCrLf & _
                     "【キャンセル】：処理を中止", vbYesNoCancel + vbQuestion, "データ保存・新規発行の選択")

        Select Case res
            Case vbYes ' 上書き保存
                dataRow = foundRange.Row
                Call SaveRirekiData(wsRireki, wsSearch, dataRow, False)
                ThisWorkbook.Save
                MsgBox "依頼NO「" & targetIraiNo & "」のデータは上書き保存されました。", vbInformation, "保存完了"
                
            Case vbNo ' 新規発行
NewPublishFlow:
                ' 新しい行を最終行の下に追加
                dataRow = wsRireki.Cells(wsRireki.Rows.Count, "A").End(xlUp).Row + 1
                
                ' 新しい依頼NOを発番
                newIraiNo = GetNewIraiNo(wsRireki)
                
                ' 新しい依頼NOを依頼履歴と依頼検索のA2セルに転記
                wsRireki.Cells(dataRow, 1).Value = newIraiNo
                wsSearch.Range("A2").Value = newIraiNo
                
                ' データの転記と日付の設定
                Call SaveRirekiData(wsRireki, wsSearch, dataRow, True)
                ThisWorkbook.Save
                MsgBox "新しい依頼NO「" & newIraiNo & "」として新規発行（保存）されました。", vbInformation, "新規発行完了"
                
            Case vbCancel
                MsgBox "処理はキャンセルされました。", vbExclamation
                Exit Sub
        End Select
    End If

End Sub


'================================================================================
' 【一括実行用】依頼履歴の更新と依頼情報の検索・転記を連続で実行する関数
' 成功した場合はTrue、失敗した場合はFalseを返す
'================================================================================
Function ExecuteUpdateAndSearch() As Boolean
    ExecuteUpdateAndSearch = False ' デフォルトは失敗
    Dim success As Boolean

    ' 1. 依頼履歴を最新に更新 (メッセージを表示)
    success = UpdateKeiriRirekiSheet(True)
    
    If Not success Then
        ' 更新に失敗した場合、検索・転記は行わずに終了
        MsgBox "依頼履歴の更新に失敗しました。処理を中断します。", vbCritical, "一括処理失敗"
        Exit Function
    End If
    
    ' 2. 依頼情報の検索・転記を実行 (メッセージを表示)
    success = SearchAndTransferRireki(True)
    
    If success Then
        MsgBox "依頼履歴の更新と依頼情報の検索・転記がすべて完了しました。", vbInformation, "一括処理完了"
    Else
        MsgBox "依頼情報の検索・転記に失敗しました。", vbCritical, "一括処理失敗"
    End If
    
    ExecuteUpdateAndSearch = success
End Function


'================================================================================
' 【実行用マクロ】ExecuteUpdateAndSearch関数を呼び出す
' VBEやExcelのリボンから実行するために使用
'================================================================================
Sub RunUpdateAndSearch()
    ' 更新と検索を実行
    Call ExecuteUpdateAndSearch
End Sub

'================================================================================
' 【実行用マクロ】保存・新規発行の選択画面を呼び出す
' VBEやExcelのリボンから実行するために使用
'================================================================================
Sub RunSaveAndPublish()
    ' データの上書き保存または新規発行を実行
    Call SaveAndPublishRireki
End Sub


' 補足：シート存在チェック用の関数
Private Function SheetExists(ByVal wb As Workbook, ByVal sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Sheets(sheetName)
    On Error GoTo 0
    SheetExists = Not ws Is Nothing
End Function

