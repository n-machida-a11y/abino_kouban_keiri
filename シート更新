Option Explicit

'================================================================================
' 設定・定数定義
'================================================================================
Public Const IS_TEST_MODE As Boolean = True
Private Const m_TEST_FILE_PATH_FOR_TEST As String = "Z:\Users\n-machida\Desktop\工事番号管理表.xlsm"

Public Const m_IRAI_RIREKI_SHEET_NAME As String = "依頼履歴"
Public Const m_IRAI_SEARCH_SHEET_NAME As String = "依頼検索"

'================================================================================
' ボタン登録用
'================================================================================
Public Sub マクロ_検索実行(): Call ExecuteUpdateAndSearch: End Sub

Public Sub マクロ_上書き保存()
    Dim wsRireki As Worksheet: Set wsRireki = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    Dim wsSearch As Worksheet: Set wsSearch = ThisWorkbook.Sheets(m_IRAI_SEARCH_SHEET_NAME)
    Dim targetIraiNo As String: targetIraiNo = Trim(wsSearch.Range("A2").Value)
    Dim foundRange As Range, autoReason As String
    
    If targetIraiNo = "" Then
        MsgBox "依頼NOを指定してください。"
        Exit Sub
    End If

    Set foundRange = wsRireki.Columns("A").Find(What:=targetIraiNo, LookIn:=xlValues, LookAt:=xlWhole)
    If foundRange Is Nothing Then
        MsgBox "指定の依頼NOが見つかりません。"
        Exit Sub
    End If

    autoReason = GetDifferenceLog(wsRireki, wsSearch, foundRange.Row)
    If autoReason = "" Then
        If MsgBox("変更箇所が見つかりませんでした。上書きしますか？", vbYesNo + vbQuestion) = vbNo Then
            Exit Sub
        End If
        autoReason = "（変更なし）"
    Else
        If MsgBox("修正を同期して上書きしますか？" & vbCrLf & vbCrLf & autoReason, vbYesNo + vbQuestion) = vbNo Then
            Exit Sub
        End If
    End If

    Call WriteDataToRireki(wsRireki, wsSearch, foundRange.Row, False, autoReason, "")
    Call SyncAllDataToMaster(targetIraiNo, False, autoReason)
    MsgBox "同期完了しました。", vbInformation
End Sub

Public Sub マクロ_新規作成()
    Dim wsRireki As Worksheet: Set wsRireki = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    Dim wsSearch As Worksheet: Set wsSearch = ThisWorkbook.Sheets(m_IRAI_SEARCH_SHEET_NAME)
    Dim lastRow As Long, maxIraiNo As Double, newIraiNo As Long
    Dim oldIraiNo As String: oldIraiNo = Trim(wsSearch.Range("A2").Value)
    
    If MsgBox("新規依頼として登録し同期しますか？", vbYesNo + vbQuestion) = vbNo Then
        Exit Sub
    End If
    
    lastRow = wsRireki.Cells(wsRireki.Rows.Count, "A").End(xlUp).Row
    If lastRow < 3 Then
        maxIraiNo = 0
    Else
        maxIraiNo = Application.WorksheetFunction.Max(wsRireki.Range("A3:A" & lastRow))
    End If
    newIraiNo = Int(maxIraiNo) + 1
    
    wsSearch.Range("A2").Value = newIraiNo
    wsSearch.Range("A5").Value = "" 
    
    Dim nextRow As Long: nextRow = lastRow + 1
    wsRireki.Cells(nextRow, "A").Value = newIraiNo
    Call WriteDataToRireki(wsRireki, wsSearch, nextRow, True, "", oldIraiNo)
    Call SyncAllDataToMaster(CStr(newIraiNo), True, "新規発行 (元:No." & oldIraiNo & ")")
    MsgBox "新規登録が完了しました。", vbInformation
End Sub

' 内部共通：履歴への書き込み
Private Sub WriteDataToRireki(wsRireki As Worksheet, wsSearch As Worksheet, targetRow As Long, _
                              isNew As Boolean, autoReason As String, oldIraiNo As String)
    Dim col As Long
    For col = 1 To 8: wsRireki.Cells(targetRow, 1 + col).Value = wsSearch.Cells(5, col).Value: Next
    For col = 1 To 9: wsRireki.Cells(targetRow, 9 + col).Value = wsSearch.Cells(7, col).Value: Next
    
    For col = 1 To 7
        If isNew = True And col = 6 Then
            wsRireki.Cells(targetRow, 18 + col).Value = ""
        Else
            wsRireki.Cells(targetRow, 18 + col).Value = wsSearch.Cells(9, col).Value
        End If
    Next col

    Dim history As String: history = wsRireki.Cells(targetRow, 24).Value
    Dim timeStamp As String: timeStamp = Format(Now, "yyyy/mm/dd hh:mm")
    Dim entry As String
    
    If isNew = True Then
        entry = "【新規発行】 " & timeStamp & IIf(oldIraiNo <> "", " (元:No." & oldIraiNo & "から再発行)", "")
    Else
        entry = "【更新】 " & timeStamp & vbCrLf & autoReason
    End If
    
    wsRireki.Cells(targetRow, 24).Value = IIf(history = "", entry, history & vbCrLf & "---" & vbCrLf & entry)
    wsSearch.Cells(9, 6).Value = wsRireki.Cells(targetRow, 24).Value
    ThisWorkbook.Save
End Sub

Private Function GetDifferenceLog(wsRireki As Worksheet, wsSearch As Worksheet, targetRow As Long) As String
    Dim log As String: log = ""
    Dim checkItems, i As Long
    checkItems = Array(Array("担当者", "C5", 4), Array("工事番号", "D5", 5), Array("工事名称", "E5", 6), _
                       Array("工期着手", "F5", 7), Array("工期完成", "G5", 8), Array("請負金額", "H5", 9), _
                       Array("提出日付", "E7", 14), Array("宛先", "G7", 16))
    
    For i = LBound(checkItems) To UBound(checkItems)
        Dim nV: nV = wsSearch.Range(checkItems(i)(1)).Value
        Dim oV: oV = wsRireki.Cells(targetRow, checkItems(i)(2)).Value
        If IsDate(nV) Or IsDate(oV) Then
            If Format(nV, "yyyy/mm/dd") <> Format(oV, "yyyy/mm/dd") Then
                log = log & checkItems(i)(0) & "：" & Format(oV, "yyyy/mm/dd") & " → " & Format(nV, "yyyy/mm/dd") & vbCrLf
            End If
        ElseIf CStr(nV) <> CStr(oV) Then
            log = log & checkItems(i)(0) & "：" & oV & " → " & nV & vbCrLf
        End If
    Next i
    GetDifferenceLog = log
End Function

Public Sub SyncAllDataToMaster(ByVal targetIraiNo As String, ByVal isNew As Boolean, ByVal logMsg As String)
    Dim mPath As String, wbM As Workbook, wsM As Worksheet, wsS As Worksheet
    Dim targetRow As Long, col As Long
    Set wsS = ThisWorkbook.Sheets(m_IRAI_SEARCH_SHEET_NAME)
    mPath = GetMasterPath()
    If Dir(mPath) = "" Then Exit Sub
    Application.ScreenUpdating = False
    On Error Resume Next: Set wbM = Workbooks.Open(mPath, ReadOnly:=False): On Error GoTo 0
    If wbM Is Nothing Then Exit Sub
    Set wsM = wbM.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    If isNew = True Then
        targetRow = wsM.Cells(wsM.Rows.Count, "A").End(xlUp).Row + 1
        wsM.Cells(targetRow, "A").Value = targetIraiNo
    Else
        Dim f As Range: Set f = wsM.Columns("A").Find(targetIraiNo, LookAt:=xlWhole)
        If f Is Nothing Then
            wbM.Close False: Exit Sub
        End If
        targetRow = f.Row
    End If
    For col = 1 To 8: wsM.Cells(targetRow, 1 + col).Value = wsS.Cells(5, col).Value: Next
    For col = 1 To 9: wsM.Cells(targetRow, 9 + col).Value = wsS.Cells(7, col).Value: Next
    For col = 1 To 7: wsM.Cells(targetRow, 18 + col).Value = wsS.Cells(9, col).Value: Next
    
    Dim fLoc As Range: Set fLoc = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME).Columns("A").Find(targetIraiNo)
    If Not fLoc Is Nothing Then
        wsM.Cells(targetRow, 24).Value = fLoc.Offset(0, 23).Value
    End If
    
    wbM.Save: wbM.Close False: Application.ScreenUpdating = True
End Sub

Public Function GetMasterPath() As String
    If IS_TEST_MODE = True Then
        GetMasterPath = m_TEST_FILE_PATH_FOR_TEST
    Else
        GetMasterPath = Trim(CStr(ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME).Range("G1").Value))
    End If
End Function

Function ExecuteUpdateAndSearch() As Boolean
    ExecuteUpdateAndSearch = False
    If UpdateKeiriRirekiSheet(False) = False Then
        Exit Function
    End If
    Dim wsR As Worksheet: Set wsR = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    Dim wsS As Worksheet: Set wsS = ThisWorkbook.Sheets(m_IRAI_SEARCH_SHEET_NAME)
    Dim ir As String: ir = Trim(wsS.Range("A2").Value)
    Dim f As Range: Set f = wsR.Columns("A").Find(ir, LookIn:=xlValues, LookAt:=xlWhole)
    If f Is Nothing Then
        wsS.Range("A5:H5, A7:I7, A9:G9").ClearContents
        Exit Function
    End If
    Dim r As Long: r = f.Row: Dim c As Long
    For c = 1 To 8: wsS.Cells(5, c).Value = wsR.Cells(r, 1 + c).Value: Next
    For c = 1 To 9: wsS.Cells(7, c).Value = wsR.Cells(r, 9 + c).Value: Next
    For c = 1 To 7: wsS.Cells(9, c).Value = wsR.Cells(r, 18 + c).Value: Next
    ExecuteUpdateAndSearch = True
End Function

Function UpdateKeiriRirekiSheet(Optional ByVal ShowMessage As Boolean = True) As Boolean
    Dim wbT As Workbook, wsSrc As Worksheet, wsDst As Worksheet, p As String, l As Long
    UpdateKeiriRirekiSheet = False: Application.ScreenUpdating = False: p = GetMasterPath()
    If Dir(p) = "" Then Exit Function
    On Error Resume Next: Set wbT = Workbooks.Open(p, ReadOnly:=True, UpdateLinks:=0): On Error GoTo 0
    If wbT Is Nothing Then Exit Function
    Set wsSrc = wbT.Sheets(m_IRAI_RIREKI_SHEET_NAME): Set wsDst = ThisWorkbook.Sheets(m_IRAI_RIREKI_SHEET_NAME)
    wsDst.Range("A3:W" & wsDst.Rows.Count).Clear: l = wsSrc.Cells(wsSrc.Rows.Count, "A").End(xlUp).Row
    If l >= 2 Then wsSrc.Range("A2:W" & l).Copy wsDst.Range("A3")
    wbT.Close False
    If ShowMessage = True Then
        MsgBox "更新されました。"
    End If
    UpdateKeiriRirekiSheet = True: Application.ScreenUpdating = True
End Function
